# User Hierarchy and Reference Code System - Workflow Documentation

## Overview

This document describes how the User Hierarchy and Reference Code System works, including user flows, business processes, and technical workflows.

## Table of Contents

1. [System Architecture Flow](#system-architecture-flow)
2. [User Registration Workflow](#user-registration-workflow)
3. [Hierarchy Management Workflow](#hierarchy-management-workflow)
4. [Project Assignment Workflow](#project-assignment-workflow)
5. [Financial Data Access Workflow](#financial-data-access-workflow)
6. [Notification System Workflow](#notification-system-workflow)
7. [Agent Pricing Workflow](#agent-pricing-workflow)
8. [Error Handling Workflow](#error-handling-workflow)
9. [Development Workflow](#development-workflow)
10. [Deployment Workflow](#deployment-workflow)

## System Architecture Flow

### High-Level System Flow

```mermaid
graph TB
    A[User Access] --> B{Authentication}
    B -->|Success| C[Role-Based Dashboard]
    B -->|Failure| D[Login Page]
    
    C --> E{User Role}
    E -->|Super Agent| F[Super Agent Dashboard]
    E -->|Agent| G[Agent Dashboard]
    E -->|Super Worker| H[Super Worker Dashboard]
    E -->|Worker| I[Worker Dashboard]
    E -->|Client| J[Client Dashboard]
    
    F --> K[System Management]
    G --> L[Client Management]
    H --> M[Worker Management]
    I --> N[Project Tasks]
    J --> O[Project Submission]
    
    K --> P[Database Operations]
    L --> P
    M --> P
    N --> P
    O --> P
```

### Data Flow Architecture

```mermaid
graph LR
    A[Frontend React App] --> B[Express.js API]
    B --> C[Authentication Middleware]
    C --> D[Permission Middleware]
    D --> E[Route Handlers]
    E --> F[Service Layer]
    F --> G[Database Layer]
    G --> H[PostgreSQL Database]
    
    E --> I[Error Handling]
    I --> J[User-Friendly Responses]
    
    F --> K[Audit Logging]
    K --> H
```

## User Registration Workflow

### New User Registration Process

```mermaid
sequenceDiagram
    participant U as New User
    participant F as Frontend
    participant A as API
    participant R as Reference Code Service
    participant H as Hierarchy Service
    participant D as Database
    
    U->>F: Enter registration details + reference code
    F->>A: POST /api/auth/register
    A->>R: Validate reference code
    R->>D: Check code validity and ownership
    D-->>R: Code validation result
    R-->>A: Validation response
    
    alt Valid Code
        A->>D: Create user account
        A->>H: Assign to hierarchy based on code
        H->>D: Create hierarchy relationship
        A->>R: Mark code as used
        A-->>F: Registration success + JWT token
        F-->>U: Welcome to dashboard
    else Invalid Code
        A-->>F: Registration error
        F-->>U: Error message with guidance
    end
```

### Reference Code Types and Hierarchy Assignment

| Code Type | Generated By | Assigns User To | Hierarchy Level |
|-----------|--------------|-----------------|-----------------|
| `client_recruitment` | Agent/Super Agent | Under code owner | Level 3-4 |
| `agent_recruitment` | Super Agent | Under Super Agent | Level 2 |
| `worker_recruitment` | Super Worker/Agent | Under code owner | Level 4-5 |

## Hierarchy Management Workflow

### Hierarchy Structure

```
Level 1: Super Agent (System Administrator)
├── Level 2: Agent (Client Manager)
│   ├── Level 3: Super Worker (Team Lead)
│   │   └── Level 4: Worker (Task Executor)
│   └── Level 3: Client (Project Owner)
└── Level 2: Direct Client (VIP Client)
```

### User Movement in Hierarchy

```mermaid
sequenceDiagram
    participant SA as Super Agent
    participant F as Frontend
    participant A as API
    participant H as Hierarchy Service
    participant D as Database
    
    SA->>F: Request to move user
    F->>A: PUT /api/hierarchy-operations/move-user
    A->>H: Validate hierarchy move
    H->>D: Check business rules
    D-->>H: Validation result
    
    alt Valid Move
        H->>D: Update user hierarchy
        H->>D: Log hierarchy change
        A-->>F: Move successful
        F-->>SA: Success notification
    else Invalid Move
        H-->>A: Validation error
        A-->>F: Error with explanation
        F-->>SA: Error message with guidance
    end
```

### Hierarchy Business Rules

1. **Super Agents** cannot be moved
2. **Agents** can only be under Super Agents
3. **Super Workers** can be under Agents or Super Agents
4. **Workers** can be under Super Workers, Agents, or Super Agents
5. **Clients** can be under Agents or Super Agents
6. Maximum hierarchy depth: 5 levels
7. No circular references allowed

## Project Assignment Workflow

### Project Creation and Assignment

```mermaid
sequenceDiagram
    participant C as Client
    participant F as Frontend
    participant A as API
    participant P as Project Service
    participant AS as Assignment Service
    participant D as Database
    
    C->>F: Submit new project
    F->>A: POST /api/projects
    A->>P: Create project record
    P->>D: Insert project
    
    A->>AS: Auto-assign based on hierarchy
    AS->>D: Check available workers
    AS->>D: Validate assignment rules
    AS->>D: Create assignment record
    AS->>D: Update project with assignments
    
    A-->>F: Project created successfully
    F-->>C: Confirmation with project details
```

### Assignment Types and Rules

| Assignment Type | Who Can Assign | Assigned To | Purpose |
|----------------|----------------|-------------|---------|
| `agent` | Super Agent | Agent | Project management |
| `sub_agent` | Agent | Sub-Agent | Delegation |
| `worker` | Agent/Super Worker | Worker | Task execution |
| `sub_worker` | Super Worker | Worker | Additional support |

### Assignment Validation Process

```mermaid
graph TD
    A[Assignment Request] --> B{Validate Assignee Role}
    B -->|Invalid| C[Return Error]
    B -->|Valid| D{Check Hierarchy Relationship}
    D -->|Invalid| C
    D -->|Valid| E{Check Workload}
    E -->|Overloaded| F[Suggest Alternatives]
    E -->|Available| G[Create Assignment]
    G --> H[Log Assignment History]
    H --> I[Send Notifications]
```

## Financial Data Access Workflow

### Role-Based Financial Data Access

```mermaid
graph TD
    A[User Requests Financial Data] --> B{Identify User Role}
    
    B -->|Super Agent| C[Full Financial Access]
    B -->|Agent| D[Agent-Limited Access]
    B -->|Super Worker| E[Worker Payment Access]
    B -->|Worker| F[No Financial Access]
    B -->|Client| G[Own Project Pricing Only]
    
    C --> H[All System Financial Data]
    D --> I[Own Agent Fees + Subordinate Data]
    E --> J[Worker Payment Information]
    F --> K[Access Denied]
    G --> L[Own Project Costs Only]
    
    H --> M[Audit Log Entry]
    I --> M
    J --> M
    K --> M
    L --> M
```

### Financial Data Filtering Logic

```javascript
// Pseudo-code for financial data filtering
function filterFinancialData(user, data) {
    switch(user.role) {
        case 'super_agent':
            return data; // Full access
            
        case 'agent':
            return data.filter(item => 
                item.agent_id === user.id || 
                isSubordinate(item.user_id, user.id)
            );
            
        case 'super_worker':
            return data.filter(item => 
                item.type === 'worker_payment' &&
                isSubordinate(item.worker_id, user.id)
            );
            
        case 'client':
            return data.filter(item => 
                item.client_id === user.id &&
                item.type === 'pricing'
            );
            
        case 'worker':
            return []; // No financial access
    }
}
```

## Notification System Workflow

### Hierarchy-Aware Notification Delivery

```mermaid
sequenceDiagram
    participant S as Sender
    participant N as Notification Service
    participant H as Hierarchy Service
    participant D as Database
    participant R as Recipients
    
    S->>N: Send notification request
    N->>H: Get recipient hierarchy
    H->>D: Query user relationships
    D-->>H: Hierarchy data
    H-->>N: Filtered recipient list
    
    N->>D: Create notification records
    N->>R: Deliver notifications
    N->>D: Log delivery status
```

### Notification Types and Routing

| Notification Type | Sender Roles | Recipients | Delivery Method |
|------------------|--------------|------------|-----------------|
| `broadcast` | Super Agent | All users | System-wide |
| `team_update` | Agent/Super Worker | Direct subordinates | Hierarchy-based |
| `project_assignment` | Any with permission | Assigned user | Direct |
| `system_alert` | System | Role-based | Filtered |

## Agent Pricing Workflow

### Pricing Configuration Process

```mermaid
sequenceDiagram
    participant A as Agent
    participant F as Frontend
    participant API as API
    participant P as Pricing Service
    participant D as Database
    
    A->>F: Update pricing configuration
    F->>API: PUT /api/agent-pricing/current
    API->>P: Validate pricing ranges
    P->>D: Check constraints
    
    alt Valid Pricing
        P->>D: Update pricing record
        P->>D: Create history entry
        API-->>F: Update successful
        F-->>A: Confirmation message
    else Invalid Pricing
        P-->>API: Validation error
        API-->>F: Error details
        F-->>A: Error message with guidance
    end
```

### Pricing Calculation Flow

```mermaid
graph TD
    A[Project Word Count] --> B[Get Agent Pricing Config]
    B --> C[Calculate Base Units]
    C --> D[Base Cost = Units × Rate]
    D --> E[Agent Fee = Base Cost × Fee %]
    E --> F[Client Total = Base Cost + Agent Fee]
    F --> G[System Calculations]
    G --> H[Super Worker Fee]
    G --> I[Worker Fee]
    H --> J[Total System Cost]
    I --> J
```

## Error Handling Workflow

### Comprehensive Error Handling Process

```mermaid
graph TD
    A[User Action] --> B[API Request]
    B --> C{Validation}
    C -->|Pass| D[Business Logic]
    C -->|Fail| E[Validation Error]
    
    D --> F{Permission Check}
    F -->|Pass| G[Database Operation]
    F -->|Fail| H[Permission Error]
    
    G --> I{Database Success}
    I -->|Success| J[Success Response]
    I -->|Fail| K[Database Error]
    
    E --> L[Error Handler]
    H --> L
    K --> L
    
    L --> M[Log Error]
    L --> N[User-Friendly Message]
    L --> O[Error Response]
    
    M --> P[Error Reporting Service]
    N --> Q[Frontend Display]
```

### Error Types and User Experience

| Error Type | User Experience | Recovery Action |
|------------|-----------------|-----------------|
| `VALIDATION_ERROR` | Form validation feedback | Fix input and retry |
| `PERMISSION_DENIED` | Graceful degradation UI | Contact administrator |
| `HIERARCHY_VIOLATION` | Explanation with alternatives | Choose valid option |
| `NETWORK_ERROR` | Retry mechanism | Automatic retry or manual |
| `DATABASE_ERROR` | Generic error message | Contact support |

## Development Workflow

### Feature Development Process

```mermaid
graph TD
    A[Feature Request] --> B[Create Spec]
    B --> C[Requirements Gathering]
    C --> D[Design Document]
    D --> E[Implementation Plan]
    E --> F[Task Breakdown]
    
    F --> G[Database Changes]
    F --> H[Backend Implementation]
    F --> I[Frontend Implementation]
    F --> J[Testing]
    
    G --> K[Migration Scripts]
    H --> L[API Endpoints]
    I --> M[UI Components]
    J --> N[Integration Tests]
    
    K --> O[Code Review]
    L --> O
    M --> O
    N --> O
    
    O --> P[Deployment]
    P --> Q[Production Testing]
    Q --> R[Feature Complete]
```

### Code Quality Workflow

1. **Linting**: ESLint for JavaScript/TypeScript
2. **Type Checking**: TypeScript compilation
3. **Testing**: Unit and integration tests
4. **Code Review**: Peer review process
5. **Security**: Dependency scanning
6. **Performance**: Bundle size analysis

## Deployment Workflow

### Production Deployment Process

```mermaid
sequenceDiagram
    participant D as Developer
    participant G as Git Repository
    participant CI as CI/CD Pipeline
    participant S as Staging
    participant P as Production
    participant M as Monitoring
    
    D->>G: Push code changes
    G->>CI: Trigger build pipeline
    CI->>CI: Run tests
    CI->>CI: Build application
    CI->>S: Deploy to staging
    
    CI->>D: Staging deployment complete
    D->>S: Manual testing
    D->>CI: Approve production deployment
    
    CI->>P: Deploy to production
    CI->>M: Update monitoring
    P->>M: Health check
    M->>D: Deployment status
```

### Deployment Checklist

#### Pre-Deployment
- [ ] All tests passing
- [ ] Database migrations ready
- [ ] Environment variables configured
- [ ] SSL certificates valid
- [ ] Backup procedures tested

#### Deployment
- [ ] Database migrations executed
- [ ] Application deployed
- [ ] Health checks passing
- [ ] Monitoring configured
- [ ] Error tracking active

#### Post-Deployment
- [ ] Functionality testing
- [ ] Performance monitoring
- [ ] Error rate monitoring
- [ ] User feedback collection
- [ ] Rollback plan ready

## Business Process Workflows

### Client Onboarding Process

1. **Agent generates client reference code**
2. **Client receives code and registers**
3. **System assigns client to agent's hierarchy**
4. **Agent configures client-specific pricing**
5. **Client gains access to project submission**
6. **Automated project assignment begins**

### Project Lifecycle

1. **Client submits project with requirements**
2. **System calculates pricing using agent's rates**
3. **Agent reviews and approves project**
4. **System assigns workers based on hierarchy**
5. **Workers complete tasks and update status**
6. **Agent reviews and delivers to client**
7. **Financial transactions processed**
8. **Project archived with full audit trail**

### Performance Monitoring Workflow

```mermaid
graph TD
    A[System Metrics] --> B[Performance Dashboard]
    A --> C[Error Tracking]
    A --> D[User Analytics]
    
    B --> E[Response Time Alerts]
    C --> F[Error Rate Alerts]
    D --> G[Usage Pattern Analysis]
    
    E --> H[Auto-scaling Triggers]
    F --> I[Incident Response]
    G --> J[Capacity Planning]
```

## Security Workflows

### Authentication Flow
1. User provides credentials
2. System validates against database
3. JWT token generated with user context
4. Token includes role and hierarchy information
5. Token used for subsequent requests
6. Token refresh mechanism for long sessions

### Authorization Flow
1. Extract user context from JWT
2. Check required permissions for endpoint
3. Validate hierarchy relationships if needed
4. Allow or deny access
5. Log access attempts for audit

### Data Protection Flow
1. Identify data sensitivity level
2. Apply role-based filtering
3. Mask sensitive information
4. Log data access
5. Audit trail maintenance

---

**Note**: This workflow documentation should be updated as the system evolves and new features are added.